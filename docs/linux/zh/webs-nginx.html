<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx | Linux 实践指南</title>
    <meta name="description" content="本文档是Websoft9在实践中，总结的与Linux有关的操作、命令、脚本，帮助云计算用户快速掌握Linux相关的技能">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/docs/linux/favcon.ico">
    
    <link rel="preload" href="/docs/linux/assets/css/0.styles.c3977e2e.css" as="style"><link rel="preload" href="/docs/linux/assets/js/app.24ba349a.js" as="script"><link rel="preload" href="/docs/linux/assets/js/2.ea18336a.js" as="script"><link rel="preload" href="/docs/linux/assets/js/26.9ddd0c25.js" as="script"><link rel="prefetch" href="/docs/linux/assets/js/10.628f32fb.js"><link rel="prefetch" href="/docs/linux/assets/js/11.6da8baf3.js"><link rel="prefetch" href="/docs/linux/assets/js/12.920fc7d1.js"><link rel="prefetch" href="/docs/linux/assets/js/13.71ff1830.js"><link rel="prefetch" href="/docs/linux/assets/js/14.48b65e4b.js"><link rel="prefetch" href="/docs/linux/assets/js/15.6263dc56.js"><link rel="prefetch" href="/docs/linux/assets/js/16.c4cfa347.js"><link rel="prefetch" href="/docs/linux/assets/js/17.238d7a5a.js"><link rel="prefetch" href="/docs/linux/assets/js/18.22577d3c.js"><link rel="prefetch" href="/docs/linux/assets/js/19.9004e01a.js"><link rel="prefetch" href="/docs/linux/assets/js/20.e9ff589d.js"><link rel="prefetch" href="/docs/linux/assets/js/21.6ed8e85e.js"><link rel="prefetch" href="/docs/linux/assets/js/22.4df81e94.js"><link rel="prefetch" href="/docs/linux/assets/js/23.9f8dcaa8.js"><link rel="prefetch" href="/docs/linux/assets/js/24.e2b9ce84.js"><link rel="prefetch" href="/docs/linux/assets/js/25.5991a162.js"><link rel="prefetch" href="/docs/linux/assets/js/27.9912d7b2.js"><link rel="prefetch" href="/docs/linux/assets/js/28.f9ac0198.js"><link rel="prefetch" href="/docs/linux/assets/js/3.24edb1e2.js"><link rel="prefetch" href="/docs/linux/assets/js/4.411dd1b5.js"><link rel="prefetch" href="/docs/linux/assets/js/5.510a9407.js"><link rel="prefetch" href="/docs/linux/assets/js/6.06aa9940.js"><link rel="prefetch" href="/docs/linux/assets/js/7.ffa1085e.js"><link rel="prefetch" href="/docs/linux/assets/js/8.561bd282.js"><link rel="prefetch" href="/docs/linux/assets/js/9.1424bb30.js">
    <link rel="stylesheet" href="/docs/linux/assets/css/0.styles.c3977e2e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/linux/zh/" class="home-link router-link-active"><!----> <span class="site-name">Linux 实践指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/linux/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://support.websoft9.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  支持
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/docs/linux/zh/webs-nginx.html" class="nav-link router-link-exact-active router-link-active">
  中文
</a></li></ul></div></div> <a href="https://github.com/Websoft9/linux" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/linux/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://support.websoft9.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  支持
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/docs/linux/zh/webs-nginx.html" class="nav-link router-link-exact-active router-link-active">
  中文
</a></li></ul></div></div> <a href="https://github.com/Websoft9/linux" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/linux/zh/" class="sidebar-link">关于</a></li><li><a href="/docs/linux/zh/admin-concept.html" class="sidebar-link">概念</a></li><li><a href="/docs/linux/zh/admin-desktop.html" class="sidebar-link">桌面</a></li><li><a href="/docs/linux/zh/admin-file.html" class="sidebar-link">磁盘与文件</a></li><li><a href="/docs/linux/zh/admin-user.html" class="sidebar-link">用户管理</a></li><li><a href="/docs/linux/zh/admin-package.html" class="sidebar-link">包和仓库</a></li><li><a href="/docs/linux/zh/admin-safe.html" class="sidebar-link">网络与安全</a></li><li><a href="/docs/linux/zh/admin-automation.html" class="sidebar-link">自动化运维</a></li><li><a href="/docs/linux/zh/admin-practices.html" class="sidebar-link">最佳实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>应用服务器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/linux/zh/webs-apache.html" class="sidebar-link">Apache</a></li><li><a href="/docs/linux/zh/webs-nginx.html" class="active sidebar-link">Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#命令和服务" class="sidebar-link">命令和服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#命令" class="sidebar-link">命令</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#服务" class="sidebar-link">服务</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#模块" class="sidebar-link">模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#查看" class="sidebar-link">查看</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#安装-2" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#启停" class="sidebar-link">启停</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#路径" class="sidebar-link">路径</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#centos" class="sidebar-link">CentOS</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#ubuntu" class="sidebar-link">Ubuntu</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#性能管理" class="sidebar-link">性能管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#进程模型" class="sidebar-link">进程模型</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#io多路复用" class="sidebar-link">IO多路复用</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#最大打开文件数" class="sidebar-link">最大打开文件数</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#压缩" class="sidebar-link">压缩</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#配置" class="sidebar-link">配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#nginx-监控" class="sidebar-link">Nginx 监控</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#静态文件处理" class="sidebar-link">静态文件处理</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#动态页面请求处理" class="sidebar-link">动态页面请求处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#伪静态" class="sidebar-link">伪静态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#基本设置" class="sidebar-link">基本设置</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#场景" class="sidebar-link">场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#virtualhost配置" class="sidebar-link">VirtualHost配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#http-virtualhost-template" class="sidebar-link">HTTP VirtualHost template</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#alias-template" class="sidebar-link">Alias template</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#https-virtualhost-template" class="sidebar-link">HTTPS VirtualHost template</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#特殊场景" class="sidebar-link">特殊场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#代理" class="sidebar-link">代理</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#负载均衡" class="sidebar-link">负载均衡</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#日志" class="sidebar-link">日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#访问日志" class="sidebar-link">访问日志</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#错误日志" class="sidebar-link">错误日志</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#安全" class="sidebar-link">安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#更新" class="sidebar-link">更新</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#dos攻击" class="sidebar-link">DoS攻击</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#ssl-tls-加密" class="sidebar-link">SSL/TLS 加密</a></li></ul></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#运行环境" class="sidebar-link">运行环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#php" class="sidebar-link">PHP</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#java" class="sidebar-link">Java</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#python" class="sidebar-link">Python</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#node-js" class="sidebar-link">Node.js</a></li><li class="sidebar-sub-header"><a href="/docs/linux/zh/webs-nginx.html#ruby" class="sidebar-link">Ruby</a></li></ul></li></ul></li><li><a href="/docs/linux/zh/webs-tomcat.html" class="sidebar-link">Tomcat</a></li><li><a href="/docs/linux/zh/webs-caddy.html" class="sidebar-link">Caddy</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>程序开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/linux/zh/lang-php.html" class="sidebar-link">PHP</a></li><li><a href="/docs/linux/zh/lang-java.html" class="sidebar-link">Java</a></li><li><a href="/docs/linux/zh/lang-python.html" class="sidebar-link">Python</a></li><li><a href="/docs/linux/zh/lang-nodejs.html" class="sidebar-link">Node.js</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/linux/zh/else-faq.html" class="sidebar-link">FAQ</a></li><li><a href="/docs/linux/zh/else-troubleshooting.html" class="sidebar-link">故障处理</a></li><li><a href="/docs/linux/zh/else-glossary.html" class="sidebar-link">词汇表</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h1> <p><a href="http://nginx.org/" target="_blank" rel="noopener noreferrer">Nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(&quot;engine x&quot;)是一款是由俄罗斯的程序设计师Igor Sysoev所开发高性能的Web和反向代理服务器，具有优异的静态资源处理能力，同时也是一个 IMAP/POP3/SMTP 代理服务器。在高连接并发的情况下，Nginx是Apache服务器不错的替代品。</p> <p><img src="https://libs.websoft9.com/Websoft9/DocsPicture/zh/nginx/nginx-architecture-websoft9.png" alt=""></p> <p>本章所提及的Nginx，具体是指NGINX Open Source（即Nginx开源Web服务器）。实际上：</p> <p>Nginx公司还有企业级的商业产品：</p> <ul><li>NGINX Plus</li> <li>NGINX Controller</li> <li>NGINX Unit</li> <li>NGINX Amplify</li> <li>NGINX WAF</li></ul> <p>同时基于Nginx的著名开源项目包括：</p> <ul><li>Tengine：由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。</li> <li>OpenResty：一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</li></ul> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>安装Nginx有在线包安装和源码编译安装两种方式。其中在线安装通常称之为 yum/apt 安装，而源码安装即需要下载源码然后进行编译后方可使用。</p> <p>相比源码编译安装来说，在线安装非常简单，下面是在线安装的范例：</p> <div class="language- extra-class"><pre class="language-text"><code># Fedora/CentOS/Red Hat
sudo yum install nginx
sudo systemctl enable nginx
sudo systemctl start nginx

# Ubuntu/Debian
sudo apt install nginx
sudo service nginx start
</code></pre></div><h2 id="命令和服务"><a href="#命令和服务" class="header-anchor">#</a> 命令和服务</h2> <h3 id="命令"><a href="#命令" class="header-anchor">#</a> 命令</h3> <p>安装完成之后，系统生成一个可以运行的Nginx命令，它提供几个可选参数：</p> <div class="language- extra-class"><pre class="language-text"><code>-c &lt;path_to_config&gt;：使用指定的配置文件而不是 conf 目录下的 nginx.conf 。

-t：测试配置文件是否正确，在运行时需要重新加载配置的时候，此命令非常重要，用来检测所修改的配置文件是否有语法错误。

-v：显示 nginx 版本号。

-V：显示 nginx 的版本号以及编译环境信息以及编译时的参数。
</code></pre></div><h3 id="服务"><a href="#服务" class="header-anchor">#</a> 服务</h3> <p>在不同的操作系统下，Nginx对应的服务启停如下：</p> <div class="language- extra-class"><pre class="language-text"><code>#CentOS or Redhat
systemctl start httpd
systemctl stop httpd
systemctl restart httpd
systemctl status httpd

# Ubutnu
systemctl start apache2
systemctl stop apache2
systemctl restart apache2
systemctl status apache2
</code></pre></div><h2 id="模块"><a href="#模块" class="header-anchor">#</a> 模块</h2> <p>Nginx 采用模块化设计机制，各个模块协作共同完成处理任务。主要模块分类：</p> <ul><li>核心模块：核心模块是指Nginx服务器正常运行时必不可少的模块，它们提供了Nginx最基本最核心的服务，如进程管理、权限控制、错误日志记录等</li> <li>标准HTTP模块：编译Nginx后包含的模块，其支持Nginx服务器的标准HTTP功能。</li> <li>可选HTTP模块：主要用于扩展标准的HTTP功能，使其能够处理一些特殊的HTTP请求。在编译Nginx时，如果不指定这些模块，默认是不会安装的。</li> <li>邮件模块：主要用于支持Ningx的邮件服务。</li> <li>第三方模块：由第三方机构或者个人开发的模块，用于实现某种特殊功能。</li></ul> <p><img src="https://libs.websoft9.com/Websoft9/DocsPicture/zh/nginx/nginx-modules-websoft9.png" alt=""></p> <p>安装模块之前，先查看当前已安装的所有模块，然后再决定是否安装，最后将已安装模块启用或停止。</p> <p>更多模块机制参考博客：<a href="https://www.cnblogs.com/zy09/p/10273399.html" target="_blank" rel="noopener noreferrer">Nginx 模块及运行机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="查看"><a href="#查看" class="header-anchor">#</a> 查看</h3> <p>通过 <code>nginx -V</code> 命令可以查看已经安装的所有Nginx模块。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>~<span class="token comment"># nginx -V</span>
nginx version: nginx/1.12.2
built by gcc <span class="token number">4.8</span>.5 <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span>.5-16<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span>
built with OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
TLS SNI support enabled
configure arguments: 
--prefix<span class="token operator">=</span>/usr/share/nginx --sbin-path<span class="token operator">=</span>/usr/sbin/nginx --modules-path<span class="token operator">=</span>/usr/lib64/nginx/modules --conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf --error-log-path<span class="token operator">=</span>/var/log/nginx/error.log --http-log-path<span class="token operator">=</span>/var/log/nginx/access.log --http-client-body-temp-path<span class="token operator">=</span>/var/lib/nginx/tmp/client_body --http-proxy-temp-path<span class="token operator">=</span>/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path<span class="token operator">=</span>/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path<span class="token operator">=</span>/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path<span class="token operator">=</span>/var/lib/nginx/tmp/scgi --pid-path<span class="token operator">=</span>/run/nginx.pid --lock-path<span class="token operator">=</span>/run/lock/subsys/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-file-aio --with-ipv6 --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module<span class="token operator">=</span>dynamic --with-http_image_filter_module<span class="token operator">=</span>dynamic --with-http_geoip_module<span class="token operator">=</span>dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module<span class="token operator">=</span>dynamic --with-mail<span class="token operator">=</span>dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream<span class="token operator">=</span>dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt<span class="token operator">=</span><span class="token string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span>
</code></pre></div><h3 id="安装-2"><a href="#安装-2" class="header-anchor">#</a> 安装</h3> <h3 id="启停"><a href="#启停" class="header-anchor">#</a> 启停</h3> <h2 id="路径"><a href="#路径" class="header-anchor">#</a> 路径</h2> <p>不同的Linux发行版，对应的安装路径有一定的差异：</p> <h3 id="centos"><a href="#centos" class="header-anchor">#</a> CentOS</h3> <p>Nginx 虚拟主机配置文件：<em>/etc/nginx/conf.d/default.conf</em><br>
Nginx 主配置文件： <em>/etc/nginx/nginx.conf</em><br>
Nginx 日志文件： <em>/var/log/nginx</em><br>
Nginx 伪静态规则目录： <em>/etc/nginx/conf.d/rewrite</em></p> <h3 id="ubuntu"><a href="#ubuntu" class="header-anchor">#</a> Ubuntu</h3> <p>Nginx 虚拟主机配置文件：<em>/etc/nginx/sites-available/default</em><br>
Nginx 主配置文件：<em>/etc/nginx/nginx.conf</em><br>
Nginx 日志文件：<em>/var/log/nginx/</em></p> <h2 id="性能管理"><a href="#性能管理" class="header-anchor">#</a> 性能管理</h2> <p>以下内容参考：<a href="https://www.cnblogs.com/yyxianren/p/12106362.html" target="_blank" rel="noopener noreferrer">《nginx性能优化 汇总篇》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和<a href="https://www.ibm.com/developerworks/cn/web/wa-lo-nginx/index.html" target="_blank" rel="noopener noreferrer">《使用 Nginx 提升网站访问速度》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="进程模型"><a href="#进程模型" class="header-anchor">#</a> 进程模型</h3> <p>NGINX有一个主进程（master process）（执行特权操作，如读取配置、绑定端口）和一系列工作进程（worker process）和辅助进程（helper process）。
<img src="https://libs.websoft9.com/Websoft9/DocsPicture/zh/nginx/nginx-processes-websoft9.png" alt=""></p> <p>Nginx运行工作进程个数一般设置CPU的核心或者核心数x2。下面是一台2核CPU服务器的Nginx相关进程查看，有1个主进程，2个子进程，还有一个辅助进程。</p> <div class="language- extra-class"><pre class="language-text"><code>[root@nginx]# ps -ef --forest | grep nginx
root       747     1  0 11:48 ?        00:00:00 nginx: master process /usr/sbin/nginx
nginx      752   747  0 11:48 ?        00:00:00  \_ nginx: worker process
nginx      753   747  0 11:48 ?        00:00:00  \_ nginx: worker process
root      1756  1708  0 17:04 pts/0    00:00:00          \_ grep --color=auto nginx
</code></pre></div><p><img src="https://libs.websoft9.com/Websoft9/DocsPicture/zh/nginx/nginx-processmaster-websoft9.jpg" alt=""></p> <p>通过信号对 Nginx 进行控制</p> <h3 id="io多路复用"><a href="#io多路复用" class="header-anchor">#</a> IO多路复用</h3> <p>一般情况下并发处理机制有三种：多进程、多线程，与异步机制。Nginx对于并发的处理同时采用了三种机制。Nginx的进程分为两类：master进程与worker进程。每个master进程可以生成多个worker进程，所以其是多进程的。每个worker进程可以同时处理多个用户请求，每个用户请求会由一个线程来处理，所以其是多线程的</p> <p>对于操作系统而言，IO多路复用就是要完成操作系统IO的请求。对于IO文件的请求，当一个IO流要进行文件处理的时候，要获取一组文件的描述符，当文件描述符还没有就绪时，那么它就在等待，直到描述符一旦就绪，马上上报系统通知的机制，告诉应用程序我准备就绪，你可以来操作了。这就是IO多路复用的方式。</p> <p>worker进程采用的就是epoll多路复用机制来对后端服务器进行处理的。当后端服务器返回结果后，后端服务器就会回调epoll多路复用器，由多路复用器对相应的worker进程进行通知。此时，worker进程就会挂起当前正在处理的事务，拿IO返回结果去响应客户端请求。响应完毕后，会再继续执行挂起的事务。这个过程就是“异步非阻塞”的。</p> <h3 id="最大打开文件数"><a href="#最大打开文件数" class="header-anchor">#</a> 最大打开文件数</h3> <p>这个指令是指当一个Nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n的值保持一致。</p> <p>注：文件资源限制的配置可以在/etc/security/limits.conf设置，针对root/user等各个用户或者*代表所有用户来设置。</p> <div class="language- extra-class"><pre class="language-text"><code>*   soft nofile   65535
*   hard nofile   65535
</code></pre></div><h3 id="压缩"><a href="#压缩" class="header-anchor">#</a> 压缩</h3> <p>使用gzip压缩功能，可能为我们节约带宽，加快传输速度，有更好的体验，也为我们节约成本，所以说这是一个重点。Nginx启用压缩功能需要你来ngx_http_gzip_module模块，apache使用的是mod_deflate。</p> <p>一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，flash什么的不压缩。</p> <div class="language- extra-class"><pre class="language-text"><code>gzip on;
gzip_min_length 2k;
gzip_buffers   4 32k;
gzip_http_version 1.1;
gzip_comp_level 6;
gzip_typestext/plain text/css text/javascriptapplication/json application/javascript application/x-javascriptapplication/xml;
gzip_vary on;
gzip_proxied any;
gzip on;
</code></pre></div><h2 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h2> <p>先来看一个实际的配置文件：</p> <div class="language- extra-class"><pre class="language-text"><code>user  nobody;# 工作进程的属主
worker_processes  4;# 工作进程数，一般与 CPU 核数等同
 
#error_log  logs/error.log; 
#error_log  logs/error.log  notice; 
#error_log  logs/error.log  info; 
 
#pid        logs/nginx.pid; 
 
events { 
   use epoll;#Linux 下性能最好的 event 模式
   worker_connections  2048;# 每个工作进程允许最大的同时连接数
} 
 
http { 
   include       mime.types; 
   default_type  application/octet-stream; 
 
   #log_format  main  '$remote_addr - $remote_user [$time_local] $request ' 
   #                  '&quot;$status&quot; $body_bytes_sent &quot;$http_referer&quot; ' 
   #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'; 
 
   #access_log  off; 
   access_log  logs/access.log;# 日志文件名
 
   sendfile        on; 
   #tcp_nopush     on; 
   tcp_nodelay     on; 
 
   keepalive_timeout  65; 
 
   include      gzip.conf; 
    
   # 集群中的所有后台服务器的配置信息
   upstream tomcats { 
    server 192.168.0.11:8080 weight=10; 
    server 192.168.0.11:8081 weight=10; 
    server 192.168.0.12:8080 weight=10; 
    server 192.168.0.12:8081 weight=10; 
    server 192.168.0.13:8080 weight=10; 
    server 192.168.0.13:8081 weight=10; 
   } 
 
   server { 
       listen       80;#HTTP 的端口
       server_name  localhost; 
 
       charset utf-8; 
 
       #access_log  logs/host.access.log  main; 
 
    location ~ ^/NginxStatus/ { 
       stub_status on; #Nginx 状态监控配置
       access_log off; 
    } 
 
    location ~ ^/(WEB-INF)/ { 
       deny all; 
    } 
    
 
    location ~ \.(htm|html|asp|php|gif|jpg|jpeg|png|bmp|ico|rar|css|js|
    zip|java|jar|txt|flv|swf|mid|doc|ppt|xls|pdf|txt|mp3|wma)$ { 
            root /opt/webapp; 
       expires 24h; 
       } 
 
       location / { 
       proxy_pass http://tomcats;# 反向代理
       include proxy.conf; 
       } 
 
       error_page 404 /html/404.html; 
 
       # redirect server error pages to the static page /50x.html 
       # 
    error_page 502 503 /html/502.html; 
       error_page 500 504 /50x.html; 
       location = /50x.html { 
           root   html; 
       } 
   } 
}
</code></pre></div><h3 id="nginx-监控"><a href="#nginx-监控" class="header-anchor">#</a> Nginx 监控</h3> <p>上面是一个实际网站的配置实例，其中灰色文字为配置说明。上述配置中，首先我们定义了一个 location ~ ^/NginxStatus/，这样通过 http://localhost/NginxStatus/ 就可以监控到 Nginx 的运行信息，显示的内容如下：</p> <div class="language- extra-class"><pre class="language-text"><code>Active connections: 70 
server accepts handled requests
 14553819 14553819 19239266 
Reading: 0 Writing: 3 Waiting: 67
</code></pre></div><p>NginxStatus 显示的内容意思如下：</p> <ul><li>active connections – 当前 Nginx 正处理的活动连接数。</li> <li>server accepts handled requests -- 总共处理了 14553819 个连接 , 成功创建 14553819 次握手 ( 证明中间没有失败的 ), 总共处理了 19239266 个请求 ( 平均每次握手处理了 1.3 个数据请求 )。</li> <li>reading -- nginx 读取到客户端的 Header 信息数。</li> <li>writing -- nginx 返回给客户端的 Header 信息数。</li> <li>waiting -- 开启 keep-alive 的情况下，这个值等于 active - (reading + writing)，意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接。</li></ul> <h3 id="静态文件处理"><a href="#静态文件处理" class="header-anchor">#</a> 静态文件处理</h3> <p>通过正则表达式，我们可让 Nginx 识别出各种静态文件，例如 images 路径下的所有请求可以写为：</p> <div class="language- extra-class"><pre class="language-text"><code>location ~ ^/images/ {
root /opt/webapp/images;
}
</code></pre></div><p>而下面的配置则定义了几种文件类型的请求处理方式。</p> <div class="language- extra-class"><pre class="language-text"><code>location ~ \.(htm|html|gif|jpg|jpeg|png|bmp|ico|css|js|txt)$ {
root /opt/webapp;
expires 24h;
}
</code></pre></div><p>对于例如图片、静态 HTML 文件、js 脚本文件和 css 样式文件等，我们希望 Nginx 直接处理并返回给浏览器，这样可以大大的加快网页浏览时的速度。因此对于这类文件我们需要通过 root 指令来指定文件的存放路径，同时因为这类文件并不常修改，通过 <code>expires</code> 指令来控制其在浏览器的缓存，以减少不必要的请求。 <code>expires</code> 指令可以控制 HTTP 应答中的“ Expires ”和“ Cache-Control ”的头标（起到控制页面缓存的作用）。您可以使用例如以下的格式来书写 Expires：</p> <div class="language- extra-class"><pre class="language-text"><code>expires 1 January, 1970, 00:00:01 GMT;
expires 60s;
expires 30m;
expires 24h;
expires 1d;
expires max;
expires off;
</code></pre></div><h3 id="动态页面请求处理"><a href="#动态页面请求处理" class="header-anchor">#</a> 动态页面请求处理</h3> <p>Nginx 本身并不支持现在流行的 JSP、ASP、PHP、PERL 等动态页面，但是它可以通过反向代理将请求发送到后端的服务器，例如 Tomcat、Apache、IIS 等来完成动态页面的请求处理。前面的配置示例中，我们首先定义了由 Nginx 直接处理的一些静态文件请求后，其他所有的请求通过 proxy_pass 指令传送给后端的服务器（在上述例子中是 Tomcat）。最简单的 <code>proxy_pass</code> 用法如下：</p> <div class="language- extra-class"><pre class="language-text"><code>location / {
proxy_pass    http://localhost:8080;
proxy_set_header X-Real-IP $remote_addr;
}
</code></pre></div><p>这里我们没有使用到集群，而是将请求直接送到运行在 8080 端口的 Tomcat 服务上来完成类似 JSP 和 Servlet 的请求处理。</p> <p>当页面的访问量非常大的时候，往往需要多个应用服务器来共同承担动态页面的执行操作，这时我们就需要使用集群的架构。 Nginx 通过 <code>upstream</code> 指令来定义一个服务器的集群，最前面那个完整的例子中我们定义了一个名为 tomcats 的集群，这个集群中包括了三台服务器共 6 个 Tomcat 服务。而 proxy_pass 指令的写法变成了：</p> <div class="language- extra-class"><pre class="language-text"><code>location / {
proxy_pass    http://tomcats;
proxy_set_header X-Real-IP $remote_addr;}
</code></pre></div><p>在 Nginx 的集群配置中，Nginx 使用最简单的平均分配规则给集群中的每个节点分配请求。一旦某个节点失效时，或者重新起效时，Nginx 都会非常及时的处理状态的变化，以保证不会影响到用户的访问。</p> <h2 id="伪静态"><a href="#伪静态" class="header-anchor">#</a> 伪静态</h2> <h3 id="基本设置"><a href="#基本设置" class="header-anchor">#</a> 基本设置</h3> <p>使用伪静态有三个步骤：</p> <ol><li>确保已经安装Rewrite模块。</li> <li>在服务器目录 <em>/etc/nginx/conf.d/rewrite</em> 下新建你网站的伪静态规则文件（例如：wordpress.conf）</li> <li>在网站的<a href="/docs/linux/zh/stack-components.html#nginx">虚拟主机配置段</a> <strong>server{ }</strong> 中将伪静态规则文件 include 进来<div class="language-text extra-class"><pre class="language-text"><code>server
{
listen 80;
server_name mysite2.yourdomain.com;  # 此处修改为你的域名
index index.html index.htm index.php;
root  /data/wwwroot/mysite2;
...

## Includes one of your Rewrite rules if you need, examples
include conf.d/rewrite/wordpress.conf;  # 引入你的伪静态规则
}
</code></pre></div></li></ol> <h3 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h3> <p>伪静态的常见场景包括：重定向、隐藏页面后缀名、.htaccess文件使用</p> <h2 id="virtualhost配置"><a href="#virtualhost配置" class="header-anchor">#</a> VirtualHost配置</h2> <p>Nginx中的虚拟主机是通过server{ } 进行配置的。</p> <p>server{ } 改动务必准确无误，任何错误的修改都会导致服务器上所有的网站不可访问</p> <table><thead><tr><th>server 项</th> <th>作用说明</th> <th>必要性</th></tr></thead> <tbody><tr><td>server_name</td> <td>域名，如果配置两个域名需以空格分开</td> <td>必须填写</td></tr> <tr><td>root</td> <td>网站存放目录</td> <td>务必准确无误</td></tr> <tr><td>error_log</td> <td>错误日志路径，系统会根据定义的路径产生相关日志文件</td> <td>可以不填或删除</td></tr> <tr><td>access_log</td> <td>访问日志路径，系统会根据定义的路径产生相关日志文件</td> <td>可以不填或删除</td></tr> <tr><td>ssl_certificate</td> <td>HTTPS 证书路径</td> <td>设置 HTTPS 访问时必填</td></tr> <tr><td>ssl_certificate_key</td> <td>HTTPS 证书秘钥路径</td> <td>设置 HTTPS 访问时必填</td></tr></tbody></table> <h3 id="http-virtualhost-template"><a href="#http-virtualhost-template" class="header-anchor">#</a> HTTP VirtualHost template</h3> <div class="language- extra-class"><pre class="language-text"><code>server
       {
        listen 80;
        server_name mysite2.yourdomain.com;
        index index.html index.htm index.php;
        root  /data/wwwroot/mysite2;
        error_log /var/log/nginx/mysite2.yourdomain.com-error.log crit;
        access_log  /var/log/nginx/mysite2.yourdomain.com-access.log;
        include conf.d/extra/*.conf;

        ## Includes one of your Rewrite rules if you need, examples
        # include conf.d/rewrite/wordpress.conf;
        # include conf.d/rewrite/joomla.conf;
        }
</code></pre></div><h3 id="alias-template"><a href="#alias-template" class="header-anchor">#</a> Alias template</h3> <p>请将下面 Alias 模板插入到 default.conf 中已存在的 server{} 段中，并修改其中的 location,alias</p> <div class="language- extra-class"><pre><code>  ```
  location /mysite2
  {
   alias /data/wwwroot/mysite2;
   index index.php index.html;
   location ~ ^/mysite2/.+\.php$ {
    alias /data/wwwroot/mysite2;
    fastcgi_pass  unix:/dev/shm/php-fpm-default.sock;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME /data/wwwroot/$fastcgi_script_name;
    include        fastcgi_params; }
  include conf.d/extra/*.conf;
  }
  ```
  ![](https://libs.websoft9.com/Websoft9/DocsPicture/en/lnmp/lnmp-insertalias-websoft9.png)

  注意：Alias 模板只能插入到 server{} 配置段中
</code></pre></div><h3 id="https-virtualhost-template"><a href="#https-virtualhost-template" class="header-anchor">#</a> HTTPS VirtualHost template</h3> <p>HTTPS 配置项 到对应的 HTTP server{ } 段落中</p> <div class="language- extra-class"><pre class="language-text"><code>#-----HTTPS template start------------
listen 443 ssl; 
ssl_certificate /data/cert/xxx.crt;
ssl_certificate_key /data/cert/xxx.key;
ssl_session_timeout 5m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
ssl_prefer_server_ciphers on;
#-----HTTPS template end------------
</code></pre></div><h3 id="特殊场景"><a href="#特殊场景" class="header-anchor">#</a> 特殊场景</h3> <p>虚拟主机配置的更多特殊场景包括：默认首页名称顺序、禁用IP访问,防止恶意解析等</p> <h2 id="代理"><a href="#代理" class="header-anchor">#</a> 代理</h2> <p>Proxy_pass反向代理，用的是nginx的Proxy模块。</p> <div class="language- extra-class"><pre class="language-text"><code>第一种：
location /proxy/ {
    proxy_pass http://127.0.0.1/;
}
代理到URL：http://127.0.0.1/test.html


第二种：
location /proxy/ {
    proxy_pass http://127.0.0.1;  #少/
}
代理到URL：http://127.0.0.1/proxy/test.html


第三种：
location /proxy/ {
    proxy_pass http://127.0.0.1/aaa/;
}
代理到URL：http://127.0.0.1/aaa/test.html


第四种（相对于第三种，最后少一个 / ）
location /proxy/ {
    proxy_pass http://127.0.0.1/aaa;
}
代理到URL：http://127.0.0.1/aaatest.html
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>- proxy_set_header  Host  $host;  作用web服务器上有多个站点时，用该参数header来区分反向代理哪个域名。比如下边的代码举例。
- proxy_set_header X-Forwarded-For  $remote_addr; 作用是后端服务器上的程序获取访客真实IP，从该header头获取。部分程序需要该功能。
</code></pre></div><h2 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h2> <p>本节来源于：https://www.jianshu.com/p/10ecc107b5ee</p> <p>Proxy_pass配合upstream实现负载均衡。</p> <p>Nginx负载均衡的几种模式：</p> <ul><li>轮询：每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，就不在分配；</li> <li>权重轮询：根据后端服务器性能不通配置轮询的权重比，权重越高访问的比重越高；</li> <li>IP_Hash：根据请求的ip地址hash结果进行分配，第一次分配到A服务器，后面再请求默认还是分配到A服务器；可以解决Session失效重新登录问题；</li> <li>Fair：按后端服务器的响应时间来分配请求，响应时间短的优先分配；</li> <li>Url_hash：按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效；</li></ul> <div class="language- extra-class"><pre class="language-text"><code>http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
 
    upstream core_tomcat {
      server 192.168.1.253:80      weight=5  max_fails=3 fail_timeout=30;
      server 192.168.1.252:80      weight=1  max_fails=3 fail_timeout=30;
      server 192.168.1.251:80      backup;
    }

    server {
        listen       80;
        server_name  www.jd.com;
        location /web {
            proxy_pass http://core_tomcat;
            proxy_set_header  Host  $host;
        }
    }
 }
</code></pre></div><h2 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h2> <p>Nginx日志对于统计、系统服务排错很有用。Nginx日志主要分为两种：access_log(访问日志)和error_log(错误日志)。通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。错误日志记录了访问出错的信息，可以帮助我们定位错误的原因。本文将详细描述一下如何配置Nginx日志。</p> <p>以下内容来源于：https://blog.csdn.net/biubiuli/article/details/79481882</p> <h3 id="访问日志"><a href="#访问日志" class="header-anchor">#</a> 访问日志</h3> <p>访问日志主要记录客户端的请求。客户端向Nginx服务器发起的每一次请求都记录在这里。客户端IP，浏览器信息，referer，请求处理时间，请求URL等都可以在访问日志中得到。当然具体要记录哪些信息，你可以通过log_format指令定义。</p> <div class="language- extra-class"><pre class="language-text"><code>access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]]; # 设置访问日志
access_log off; # 关闭访问日志

</code></pre></div><ol><li>path 指定日志的存放位置。</li> <li>format 指定日志的格式。默认使用预定义的combined。</li> <li>buffer 用来指定日志写入时的缓存大小。默认是64k。</li> <li>gzip 日志写入前先进行压缩。压缩率可以指定，从1到9数值越大压缩比越高，同时压缩的速度也越慢。默认是1。</li> <li>flush 设置缓存的有效时间。如果超过flush指定的时间，缓存中的内容将被清空。</li> <li>if 条件判断。如果指定的条件计算为0或空字符串，那么该请求不会写入日志。</li></ol> <p>可以应用access_log指令的作用域分别有http，server，location，limit_except。也就是说，在这几个作用域外使用该指令，Nginx会报错。</p> <h3 id="错误日志"><a href="#错误日志" class="header-anchor">#</a> 错误日志</h3> <p>错误日志的形式如下：</p> <div class="language- extra-class"><pre class="language-text"><code>10.1.1.1 - - [22/Aug/2014:16:48:14 +0800] &quot;POST /ajax/MbpRequest.do HTTP/1.1&quot; 200 367 &quot;-&quot; &quot;Dalvik/1.6.0 (Linux; U; Android 4.1.1; ARMM7K Build/JRO03H)&quot; &quot;119.189.56.175&quot; 127.0.0.1:8090 0.022 0.022 
10.1.1.1 - - [22/Aug/2014:16:48:19 +0800] &quot;POST /ajax/MbpRequest.do HTTP/1.1&quot; 200 616 &quot;-&quot; &quot;Dalvik/1.6.0 (Linux; U; Android 4.0.4; GT-I9103 Build/IMM76D)&quot; &quot;36.250.89.22&quot; 127.0.0.1:8090 0.036 0.036 
</code></pre></div><ol><li>客户端（用户）IP地址。如：上例中的 10.1.1.1 (内网负载均衡地址)</li> <li>访问时间。如：上例中的 [22/Aug/2014:16:48:19 +0800]</li> <li>访问端口。如：上例中的 127.0.0.1:8080</li> <li>响应时间。如：上例中的 0.022</li> <li>请求时间。如：上例中的 0.022</li> <li>用户地理位置代码（国家代码）。</li> <li>请求的url地址（目标url地址）的host。如：上例中的 /....</li> <li>请求方式（GET或者POST等）。如：上例中的 GET</li> <li>请求url地址（去除host部分）。如：上例中的 /html/test.html</li> <li>请求状态（状态码，200表示成功，404表示页面不存在，301表示永久重定向等，具体状态码可以在网上找相关文章，不再赘述）。如：上例中的 &quot;200&quot;</li> <li>请求页面大小，默认为B（byte）。如：上例中的 2426</li> <li>来源页面，即从哪个页面转到本页，专业名称叫做“referer”。如：上例中的 &quot;http://a.com&quot;</li> <li>用户浏览器语言。如：上例中的 &quot;es-ES,es;q=0.8&quot;</li> <li>用户浏览器其他信息，浏览器版本、浏览器类型等。如：上例中的  &quot;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11&quot;</li></ol> <p>nginx access日志的格式不是一成不变的，是可以自定义的。在nginx的nginx.conf配置文件找到：log_format 这里就是日志的格式</p> <h2 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h2> <p>Nginx使用proxy_cache模块处理缓存。</p> <h2 id="安全"><a href="#安全" class="header-anchor">#</a> 安全</h2> <h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <h3 id="dos攻击"><a href="#dos攻击" class="header-anchor">#</a> DoS攻击</h3> <h3 id="ssl-tls-加密"><a href="#ssl-tls-加密" class="header-anchor">#</a> SSL/TLS 加密</h3> <h2 id="运行环境"><a href="#运行环境" class="header-anchor">#</a> 运行环境</h2> <p>Apache可以作为常见的开发语言的 Web 服务器，集成数据库、应用容器，最后形成一个完整的应用运行环境，例如：Apache+PHP，Apache+Tomcat+Java等</p> <p>下面我们以常见的开发语言为例，分别介绍它们是如何与Apache一起工作的。</p> <h3 id="php"><a href="#php" class="header-anchor">#</a> PHP</h3> <p>Apache被广泛用于PHP环境，Apache有两种PHP处理机制：</p> <ul><li>php-fpm：PHP内核中用来处理PHP文件的解释器和进程管理器</li> <li>mod_php：Apache的PHP处理模块</li></ul> <p>mod_php 作为Apache的模块，没有独立的进程，无需额外设置和处理，使用起来非常简单。</p> <p>PHP-FPM(PHP FastCGI Process Manager)意：PHP FastCGI 进程管理器，用于管理PHP 进程池的软件，用于接受Nginx等Web服务器的请求。PHP-FPM提供了更好的PHP进程管理方式，可以有效控制内存和进程、可以平滑重载PHP配置。</p> <p>下面是Apache+PHP-FPM共同工作的系统架构图，其中mod_proxy_fcgi用于Apache连接php-fpm</p> <p><img src="https://libs.websoft9.com/Websoft9/DocsPicture/zh/linux/apache_event_php-fpm.jpg" alt=""></p> <h3 id="java"><a href="#java" class="header-anchor">#</a> Java</h3> <p>Nginx 无法直接运行Java程序，而是与Tomcat一起组合去部署Java程序。</p> <p>这种组合下，Nginx处理静态资源，JSP等动态程序需转发给Tomcat处理，然后返回给用户。Nginx 使用 proxy_pass 模块来连接 Tomcat。</p> <p>proxy_pass 模块是基于 HTTP 协议的代理，因此它要求 Tomcat 必须提供 HTTP 服务，也就是说必须启用 Tomcat 的 HTTP Connector。常见的配置如下：</p> <div class="language- extra-class"><pre class="language-text"><code>server
{
    listen 80;
    server_name www.xxx.com;
    
    location ~* &quot;\.(jpg|png|jepg|js|css|xml|bmp|swf|gif|html)$&quot;
    {
        root /data/wwwroot/aminglinux/;
        access_log off;
        expire 7d;
    }
    
    location /
    {
        proxy_pass http://127.0.0.1:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP      $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre></div><h3 id="python"><a href="#python" class="header-anchor">#</a> Python</h3> <p>Nginx 也可以用于Python环境，通过扩展模块mod_proxy_uwsgi，连接Python的uWSGI服务器或Gunicorn服务器，便可以解析Python程序。</p> <p>这种组合的的基本配置方法如下：</p> <ol><li>配置为uwsgi.ini<div class="language- extra-class"><pre class="language-text"><code>[uwsgi]
chdir = /home/vagrant/myweb/
virtualenv = /home/vagrant/env/
socket = 127.0.0.1:8080
env = DJANGO_SETTINGS_MODULE=myweb.settings
module =myweb.wsgi:application
master = true
processes = 4
vacuum = True
max-requests = 5000
daemonize = /var/log/uwsgi.log
pidfile = /var/log/uwsgi.pid
</code></pre></div></li> <li>apache的配置文件加载mod_proxy_uwsgi.so</li> <li>apache的配置文件反向代理到uwsgi<div class="language- extra-class"><pre class="language-text"><code>ProxyPass / uwsgi://127.0.0.1:8080
</code></pre></div></li></ol> <h3 id="node-js"><a href="#node-js" class="header-anchor">#</a> Node.js</h3> <p>Nginx 也可以用于Node.js环境，Nginx 与 Node.js 最常见的连接方式是http_proxy，即利用 Apache 自带的 mod_proxy 模块使用代理技术来连接 Node.js。</p> <p>下面是典型的配置文件范例：</p> <div class="language- extra-class"><pre class="language-text"><code>server {
        listen 80 default_server;
        server_name _;


        location / {
         proxy_pass http://127.0.0.1:2368;
         proxy_set_header Host $host;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

}
</code></pre></div><h3 id="ruby"><a href="#ruby" class="header-anchor">#</a> Ruby</h3></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Websoft9/linux/edit/master/docs/zh/webs-nginx.md" target="_blank" rel="noopener noreferrer">在Github上编辑</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/13/2020, 12:56:54 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/linux/zh/webs-apache.html" class="prev">
        Apache
      </a></span> <span class="next"><a href="/docs/linux/zh/webs-tomcat.html">
        Tomcat
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/linux/assets/js/app.24ba349a.js" defer></script><script src="/docs/linux/assets/js/2.ea18336a.js" defer></script><script src="/docs/linux/assets/js/26.9ddd0c25.js" defer></script>
  </body>
</html>
